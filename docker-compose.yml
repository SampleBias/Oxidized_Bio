# ==========================================================================
# Oxidized Bio - Full Stack Docker Compose
# ==========================================================================
# 
# This file runs the complete Oxidized Bio stack:
#   - oxidized-bio: Main API server with SSH/RFC support
#   - db: PostgreSQL with pgvector for embeddings
#   - redis: Job queue and caching
#
# Usage:
#   docker compose up -d              # Start all services
#   docker compose logs -f            # View logs
#   docker compose down               # Stop all services
#   docker compose exec oxidized-bio bash  # Shell into container
#
# SSH Access (for RFC):
#   ssh oxidized@localhost -p 2222
#
# ==========================================================================

services:
  # ==========================================================================
  # Main API Server + RFC + SSH
  # ==========================================================================
  oxidized-bio:
    build:
      context: .
      dockerfile: Dockerfile
    image: ${DOCKER_REGISTRY:-s4mpl3bi4s/}oxidized-bio:${VERSION:-latest}
    container_name: oxidized-bio-api
    hostname: oxidized-bio
    
    ports:
      - "${PORT:-3000}:3000"       # HTTP API
      - "${SSH_PORT:-2222}:22"     # SSH for RFC remote access
    
    environment:
      # ======================
      # Application Settings
      # ======================
      - APP_ENV=${APP_ENV:-production}
      - RUST_LOG=${RUST_LOG:-info,oxidized_bio=debug}
      - RUST_BACKTRACE=${RUST_BACKTRACE:-1}
      
      # ======================
      # Server Configuration
      # ======================
      - PORT=3000
      - HOST=0.0.0.0
      
      # ======================
      # Database Configuration
      # ======================
      - DATABASE_URL=postgresql://${DB_USER:-postgres}:${DB_PASSWORD:-password}@db:5432/${DB_NAME:-oxidized_bio}
      
      # ======================
      # Redis Configuration
      # ======================
      - REDIS_URL=redis://redis:6379
      
      # ======================
      # Authentication
      # ======================
      - BIOAGENTS_SECRET=${BIOAGENTS_SECRET:?BIOAGENTS_SECRET is required}
      - AUTH_MODE=${AUTH_MODE:-none}
      - MAX_JWT_EXPIRATION=${MAX_JWT_EXPIRATION:-3600}
      
      # ======================
      # RFC Configuration
      # ======================
      - RFC_PASSWORD=${RFC_PASSWORD:-change-me-in-production}
      - RFC_ENABLED=${RFC_ENABLED:-true}
      - ENABLE_SSH=${ENABLE_SSH:-true}
      - SSH_PASSWORD=${SSH_PASSWORD:-oxidized}
      
      # ======================
      # LLM Providers
      # ======================
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - GOOGLE_API_KEY=${GOOGLE_API_KEY:-}
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY:-}
      - GROQ_API_KEY=${GROQ_API_KEY:-}
      - COHERE_API_KEY=${COHERE_API_KEY:-}
      
      # ======================
      # Agent LLM Configuration
      # ======================
      - REPLY_LLM_PROVIDER=${REPLY_LLM_PROVIDER:-openai}
      - REPLY_LLM_MODEL=${REPLY_LLM_MODEL:-gpt-4}
      - HYP_LLM_PROVIDER=${HYP_LLM_PROVIDER:-openai}
      - HYP_LLM_MODEL=${HYP_LLM_MODEL:-gpt-4}
      - PLANNING_LLM_PROVIDER=${PLANNING_LLM_PROVIDER:-openai}
      - PLANNING_LLM_MODEL=${PLANNING_LLM_MODEL:-gpt-4}
      - STRUCTURED_LLM_PROVIDER=${STRUCTURED_LLM_PROVIDER:-openai}
      - STRUCTURED_LLM_MODEL=${STRUCTURED_LLM_MODEL:-gpt-4}
      
      # ======================
      # Embeddings Configuration
      # ======================
      - EMBEDDING_PROVIDER=${EMBEDDING_PROVIDER:-openai}
      - TEXT_EMBEDDING_MODEL=${TEXT_EMBEDDING_MODEL:-text-embedding-3-large}
      
      # ======================
      # Vector Search Configuration
      # ======================
      - CHUNK_SIZE=${CHUNK_SIZE:-2000}
      - CHUNK_OVERLAP=${CHUNK_OVERLAP:-200}
      - VECTOR_SEARCH_LIMIT=${VECTOR_SEARCH_LIMIT:-20}
      - RERANK_FINAL_LIMIT=${RERANK_FINAL_LIMIT:-5}
      - USE_RERANKING=${USE_RERANKING:-true}
      - SIMILARITY_THRESHOLD=${SIMILARITY_THRESHOLD:-0.75}
      - RERANKER_SCORE_THRESHOLD=${RERANKER_SCORE_THRESHOLD:-0.3}
      
      # ======================
      # External Agents
      # ======================
      - OPENSCHOLAR_API_URL=${OPENSCHOLAR_API_URL:-}
      - OPENSCHOLAR_API_KEY=${OPENSCHOLAR_API_KEY:-}
      - PRIMARY_LITERATURE_AGENT=${PRIMARY_LITERATURE_AGENT:-bio}
      - BIO_LIT_AGENT_API_URL=${BIO_LIT_AGENT_API_URL:-}
      - BIO_LIT_AGENT_API_KEY=${BIO_LIT_AGENT_API_KEY:-}
      - EDISON_API_URL=${EDISON_API_URL:-}
      - EDISON_API_KEY=${EDISON_API_KEY:-}
      - PRIMARY_ANALYSIS_AGENT=${PRIMARY_ANALYSIS_AGENT:-edison}
      
      # ======================
      # Storage (S3)
      # ======================
      - STORAGE_PROVIDER=${STORAGE_PROVIDER:-}
      - S3_BUCKET=${S3_BUCKET:-}
      - S3_ENDPOINT=${S3_ENDPOINT:-}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID:-}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY:-}
      - AWS_REGION=${AWS_REGION:-us-east-1}
      
      # ======================
      # Payment Protocols
      # ======================
      - X402_ENABLED=${X402_ENABLED:-false}
      - X402_ENVIRONMENT=${X402_ENVIRONMENT:-testnet}
      - X402_PAYMENT_ADDRESS=${X402_PAYMENT_ADDRESS:-}
      - B402_ENABLED=${B402_ENABLED:-false}
      - B402_ENVIRONMENT=${B402_ENVIRONMENT:-testnet}
      - B402_PAYMENT_ADDRESS=${B402_PAYMENT_ADDRESS:-}
    
    volumes:
      # Persistent data directories
      - oxidized-data:/app/data
      - oxidized-docs:/app/docs
      - oxidized-workspace:/app/workspace
      - oxidized-logs:/app/logs
      # SSH host keys (persist across container restarts)
      - ssh-keys:/etc/ssh/keys
    
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    
    restart: unless-stopped
    
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
    # Resource limits (adjust based on your server)
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 512M

  # ==========================================================================
  # PostgreSQL with pgvector Extension
  # ==========================================================================
  db:
    image: pgvector/pgvector:pg16
    container_name: oxidized-bio-db
    hostname: db
    
    environment:
      - POSTGRES_DB=${DB_NAME:-oxidized_bio}
      - POSTGRES_USER=${DB_USER:-postgres}
      - POSTGRES_PASSWORD=${DB_PASSWORD:-password}
      - PGDATA=/var/lib/postgresql/data/pgdata
    
    volumes:
      - postgres-data:/var/lib/postgresql/data
    
    ports:
      - "${DB_PORT:-5432}:5432"
    
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-postgres} -d ${DB_NAME:-oxidized_bio}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    
    restart: unless-stopped
    
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 256M

  # ==========================================================================
  # Redis for Job Queue and Caching
  # ==========================================================================
  redis:
    image: redis:7-alpine
    container_name: oxidized-bio-redis
    hostname: redis
    
    command: >
      redis-server
      --appendonly yes
      --maxmemory 256mb
      --maxmemory-policy noeviction
      --tcp-keepalive 60
      --timeout 0
    
    volumes:
      - redis-data:/data
    
    ports:
      - "${REDIS_PORT:-6379}:6379"
    
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    
    restart: unless-stopped
    
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 64M

# ==========================================================================
# Named Volumes for Persistent Storage
# ==========================================================================
volumes:
  postgres-data:
    driver: local
  redis-data:
    driver: local
  oxidized-data:
    driver: local
  oxidized-docs:
    driver: local
  oxidized-workspace:
    driver: local
  oxidized-logs:
    driver: local
  ssh-keys:
    driver: local

# ==========================================================================
# Network Configuration
# ==========================================================================
networks:
  default:
    name: oxidized-bio-network
    driver: bridge
